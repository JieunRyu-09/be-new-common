<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="chat">

    <select id="getChatRoomList" parameterType="String" resultType="hashMap">
         /*
            getChatRoomList
            사용자의 채팅방 목록 조회
         */
         SELECT T1.ROOM_IDX
                , T1.TITLE
                , T1.MEMBER_CNT
                , T1.LAST_CHAT_MSG
                , T2.UNREAD_COUNT
           FROM ch_chat_room           T1,
                ch_chat_room_member    T2
          WHERE T1.ROOM_IDX     = T2.ROOM_IDX
            AND T2.MEMBER_ID    = #{memberId}
            AND T2.DEL_YN       = 'N'
    </select>

    <select id="getChatMessages" parameterType="hashMap" resultType="chatMessageDTO">
         /*
            getChatMessages
            채팅방 채팅내역 조회
         */
         SELECT R1.MSG_IDX,
                R1.MEMBER_ID,
                R1.MEMBER_NM,
                R1.CONTENT,
                R1.MESSAGE_TYPE,
                R1.SEND_TIME,
                R1.BUNDLE_YN,
                CONCAT('[',GROUP_CONCAT(R2.FILE_IDX), ']') AS FILE_IDX,
                CONCAT('[',GROUP_CONCAT(R2.FILE_NM), ']') AS FILE_NM,
                CONCAT('[',GROUP_CONCAT(R2.FILE_PATH), ']') AS FILE_PATH
           FROM (SELECT T1.MSG_IDX,
                        T1.MEMBER_ID,
                        T2.MEMBER_NM,
                        T1.CONTENT,
                        T1.MESSAGE_TYPE,
                        DATE_FORMAT(T1.INS_DT, '%Y-%m-%d %H:%i:%s') AS SEND_TIME,
                        T1.BUNDLE_YN
                   FROM ch_chat_room_msg    T1,
                        mm_member_info      T2
                  WHERE T1.MEMBER_ID    = T2.MEMBER_ID
                    AND T1.ROOM_IDX     = #{roomIdx}
                  ORDER BY MSG_IDX DESC
                  LIMIT #{pageSize}
                <if test="startIdx != null and startIdx != ''">
                    OFFSET #{strarIdx}
                </if>
                ) R1
                LEFT JOIN ch_chat_file_info R2 ON R1.MSG_IDX = R2.MSG_IDX
          WHERE R1.MSG_IDX
          GROUP BY  MSG_IDX, MEMBER_ID, MEMBER_NM, CONTENT, MESSAGE_TYPE, SEND_TIME, BUNDLE_YN
    </select>

</mapper>

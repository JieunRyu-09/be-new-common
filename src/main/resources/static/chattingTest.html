<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>STOMP WebSocket í…ŒìŠ¤íŠ¸</title>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
    <style>
        body { font-family: sans-serif; margin: 20px; }
        input, textarea, button { margin: 5px 0; width: 100%; }
        textarea { height: 100px; }
        #logs { white-space: pre-wrap; border: 1px solid #ccc; padding: 10px; height: 200px; overflow-y: auto; background: #f9f9f9; }
        .subscription { margin-bottom: 20px; }
    </style>
</head>
<body>

<h2>ğŸ§ª STOMP WebSocket í…ŒìŠ¤íŠ¸ í˜ì´ì§€</h2>

<label>ğŸ”— WebSocket ì£¼ì†Œ</label>
<input type="text" id="wsUrl" value="ws://localhost:8081/ws">

<label>ğŸ” Authorization (ì˜ˆ: Bearer eyJ...)</label>
<input type="text" id="authHeader" value="Bearer ">

<button onclick="connect()">Connect</button>

<hr>

<div style="display: flex; gap: 20px">
    <div class="subscription" style="flex: 1">
        <label>ğŸ“¬ ì±„íŒ…ë°© ì±„ë„ (ì˜ˆ: /topic/chat/1)</label>
        <input type="text" id="subscribeDest1" value="/topic/chat/1">
        <button onclick="subscribe(1)">Subscribe 1</button>
        <button onclick="unsubscribe(1)">Unsubscribe 1</button>
    </div>
    <div class="subscription"  style="flex: 1">
        <label>ğŸ“¬ Subscribe ì±„ë„ 4 (ì˜ˆ: ì±„íŒ…ë°© ëª©ë¡ ìˆ˜ì‹ , /user/queue/unread)</label>
        <input type="text" id="subscribeDest4" value="/user/queue/unread">
        <button onclick="subscribe(4)">Subscribe 4</button>
        <button onclick="unsubscribe(4)">Unsubscribe 4</button>
    </div>
</div>

<hr>

<label>ğŸ“¤ Send ì£¼ì†Œ (ì˜ˆ: /app/chat/1)</label>
<input type="text" id="sendDest" value="/app/chat/1">

<label>âœ‰ï¸ ë³´ë‚¼ ë©”ì‹œì§€ (JSON í˜•ì‹)</label>
<textarea id="sendBody">{ "content": "Hello"}</textarea>

<button onclick="send()">Send</button>

<hr>

<!-- ... ìƒëµ ... -->

<h3>ğŸ“¥ ìˆ˜ì‹  ë©”ì‹œì§€ ë° ë¡œê·¸</h3>
<div id="logs"></div>
<button onclick="clearLogs()">ğŸ§¹ ë¡œê·¸ ì§€ìš°ê¸°</button>

<script>
	let client = null;
	const subscriptions = {}; // ì±„ë„ ë²ˆí˜¸ë³„ êµ¬ë… ì €ì¥

	function log(msg) {
		const logDiv = document.getElementById("logs");
		logDiv.textContent += msg + "\n";
		logDiv.scrollTop = logDiv.scrollHeight;
	}

	function clearLogs() {
		document.getElementById("logs").textContent = "";
	}

	function connect() {
		const wsUrl = document.getElementById("wsUrl").value;
		const token = document.getElementById("authHeader").value;

		const socket = new WebSocket(wsUrl);
		client = Stomp.over(socket);

		client.connect(
			{ Authorization: token },
			function (frame) {
				log("âœ… Connected: " + frame);
			},
			function (error) {
				log("âŒ Connection error: " + error);
			}
		);
	}


	function subscribe(channelNumber) {
		const destination = document.getElementById(`subscribeDest${channelNumber}`).value;
		const token = document.getElementById("authHeader").value;

		const subscription = client.subscribe(
			destination,
			function (message) {
				log(`ğŸ“© ì±„ë„ ${channelNumber} ìˆ˜ì‹ ë¨: ` + message.body);
			},
			{ Authorization: token }
		);

		subscriptions[channelNumber] = subscription;
		log(`ğŸ”” ì±„ë„ ${channelNumber} êµ¬ë… ìš”ì²­: ` + destination);
	}

	function unsubscribe(channelNumber) {
		const subscription = subscriptions[channelNumber];
		const token = document.getElementById("authHeader").value;
		const destination = document.getElementById(`subscribeDest${channelNumber}`).value;

		if (!subscription) {
			log(`âš ï¸ ì±„ë„ ${channelNumber}ëŠ” í˜„ì¬ êµ¬ë… ì¤‘ì´ ì•„ë‹™ë‹ˆë‹¤.`);
			return;
		}

		// headers ì¸ìì— Authorizationê³¼ x-destinationì„ ê°™ì´ ë³´ëƒ„
		subscription.unsubscribe({
			headers: {
				Authorization: token,
				'x-destination': destination
			}
		});

		log(`ğŸ”• ì±„ë„ ${channelNumber} êµ¬ë… í•´ì œ: ${destination}`);
		delete subscriptions[channelNumber];
	}


	function send() {
		const destination = document.getElementById("sendDest").value;
		const body = document.getElementById("sendBody").value;
		const token = document.getElementById("authHeader").value;

		client.send(
			destination,
			{ Authorization: token },
			body
		);
		log("ğŸ“¤ ë³´ëƒ„: " + body);
	}
</script>

<!-- ... ì•„ë˜ HTML ë§ˆê° íƒœê·¸ ìœ ì§€ ... -->
